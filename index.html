<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบลงทะเบียนอุปกรณ์คอมพิวเตอร์</title>
  <style>
    /* CSS Styles: ส่วนนี้ยังคงเดิม */
    body {
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: 'Sarabun', 'Kanit', 'Prompt', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: auto;
    }

    .app-wrapper {
      width: 100%;
      height: 100%;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 40px;
    }

    .header {
      background: #ffffff;
      padding: 15px 20px;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
      color: #667eea;
    }

    .tabs {
      display: flex;
      background: #ffffff;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tab-button {
      flex: 1;
      padding: 15px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      color: #764ba2;
      transition: background 0.3s, color 0.3s;
    }

    .tab-button.active {
      color: #ffffff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .tab-content {
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .full-width {
      grid-column: 1 / 3;
    }

    label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    input[type="text"],
    select,
    textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      border-color: #667eea;
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 700;
      transition: opacity 0.3s;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      grid-column: 1 / 3;
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .submit-btn:hover:not(:disabled) {
      opacity: 0.9;
    }

    /* Image Upload Styles */
    .image-upload-group {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      min-height: 150px;
      position: relative;
      transition: border-color 0.3s;
    }

    .image-upload-group:hover {
      border-color: #764ba2;
    }

    .image-preview {
      width: 100%;
      height: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 4px;
    }

    .clear-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      color: #000;
      padding: 5px 8px;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      display: none;
      z-index: 10;
    }

    .clear-image-btn.show {
      display: block;
    }

    .image-upload-text {
      color: #999;
      font-size: 14px;
      text-align: center;
    }

    /* Device List Styles */
    .device-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .device-card {
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }

    .device-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
    }

    .device-card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #eee;
      border-bottom: 1px solid #ddd;
    }

    .device-card-content {
      padding: 15px;
    }

    .device-card-content h3 {
      margin-top: 0;
      color: #667eea;
      font-size: 18px;
    }

    .device-card-content p {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }

    .badge-container {
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      margin-right: 5px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      color: #ffffff;
      background-color: #764ba2;
    }

    .no-data {
      text-align: center;
      color: #999;
      padding: 50px;
      font-size: 18px;
    }

    /* Toast Notification */
    .toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      font-size: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .toast.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    .toast.success {
      background-color: #4CAF50;
    }

    .toast.error {
      background-color: #F44336;
    }

    @keyframes fadein {
      from { bottom: 0; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }

    @keyframes fadeout {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 0; opacity: 0; }
    }

    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      form {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .full-width {
        grid-column: 1 / 2;
      }
    }
  </style>
 </head>
 <body>
  <div class="app-wrapper">
   <div class="container">
    <div class="header">
     <h1 id="app-name">ระบบลงทะเบียนอุปกรณ์คอมพิวเตอร์</h1>
    </div>
    <div class="tabs">
     <div class="tab-button active" id="tab-register-btn" onclick="switchTab('register')">
      ลงทะเบียน
     </div>
     <div class="tab-button" id="tab-list-btn" onclick="switchTab('list')">
      รายการอุปกรณ์ (<span id="device-count">0</span>)
     </div>
    </div>
    <div id="tab-register" class="tab-content active">
     <h2 style="margin-bottom: 25px; color: #667eea;" id="register-form-title">ลงทะเบียนอุปกรณ์ใหม่</h2>
     <form id="device-form" onsubmit="event.preventDefault(); handleSubmit();">
      <div class="form-group">
       <label for="device_id">รหัสทรัพย์สิน / Serial Number *</label>
       <input type="text" id="device_id" required>
      </div>
      <div class="form-group">
       <label for="device_name">ชื่ออุปกรณ์ *</label>
       <input type="text" id="device_name" required>
      </div>
      <div class="form-group">
       <label for="user_name">ชื่อผู้ใช้งาน *</label>
       <input type="text" id="user_name" required>
      </div>
      <div class="form-group" id="department-group">
       <label for="department">แผนก / หน่วยงาน *</label>
       <select id="department" required onchange="handleDropdownChange('department')">
        </select>
      </div>
      <div class="form-group" id="custom-department-group" style="display: none;">
       <label for="custom_department">ระบุแผนก / หน่วยงานอื่นๆ *</label>
       <input type="text" id="custom_department">
      </div>
      <div class="form-group" id="device-type-group">
       <label for="device_type">ประเภทอุปกรณ์ *</label>
       <select id="device_type" required onchange="handleDropdownChange('device_type')">
        </select>
      </div>
      <div class="form-group" id="custom-device-type-group" style="display: none;">
       <label for="custom_device_type">ระบุประเภทอื่นๆ *</label>
       <input type="text" id="custom_device_type">
      </div>
      <div class="form-group">
       <label for="asset_image_input">รูปภาพรหัสทรัพย์สิน (ถ่ายภาพ Serial Number หรือ QR Code)</label>
       <input type="file" id="asset_image_input" accept="image/*" style="display: none;" onchange="handleAssetImageSelect(event)">
       <div class="image-upload-group" onclick="document.getElementById('asset_image_input').click()">
        <img id="asset_image_preview" class="image-preview" src="" style="display: none;">
        <span class="clear-image-btn" id="clear-asset-image-btn" onclick="event.stopPropagation(); clearAssetImage();">x</span>
        <p class="image-upload-text" id="asset-upload-text">คลิกเพื่อเลือกหรือถ่ายภาพ</p>
       </div>
      </div>
      <div class="form-group">
       <label for="image_input">รูปภาพอุปกรณ์ (ถ่ายภาพตัวเครื่อง)</label>
       <input type="file" id="image_input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
       <div class="image-upload-group" onclick="document.getElementById('image_input').click()">
        <img id="image_preview" class="image-preview" src="" style="display: none;">
        <span class="clear-image-btn" id="clear-image-btn" onclick="event.stopPropagation(); clearImage();">x</span>
        <p class="image-upload-text" id="upload-text">คลิกเพื่อเลือกหรือถ่ายภาพ</p>
       </div>
      </div>
      <div class="form-group full-width">
       <label for="detail">รายละเอียดเพิ่มเติม (Spec, Location, IP Address ฯลฯ)</label>
       <textarea id="detail" rows="4"></textarea>
      </div>
      <button type="submit" class="submit-btn" id="submit-btn">
       <span id="submit-btn-text">บันทึกข้อมูล</span>
      </button>
     </form>
    </div>
    <div id="tab-list" class="tab-content">
     <h2 style="margin-bottom: 25px; color: #667eea;" id="list-title">รายการอุปกรณ์ที่ลงทะเบียนแล้ว</h2>
     <div id="device-list-container" class="device-list">
      </div>
    </div>
   </div>
  </div>
  <div id="toast" class="toast"></div>
  <script>
    // --------------------------------------------------------------------------------
    // ส่วนที่ 1: การตั้งค่าและการสื่อสารกับ Google Apps Script (Backend)
    // --------------------------------------------------------------------------------
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyV2HciZp797yLe6VcczOnO1gA9AJqF-JDQ6tP86rAjmonCxUX8MEOkYFZ5yi2IcUzQ/exec'; // <--- ใส่ URL ตรงนี้ 
    
    // ฟังก์ชันหลักสำหรับสื่อสารกับ Apps Script
    async function postData(action, payload) {
      if (!SCRIPT_URL || SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbyV2HciZp797yLe6VcczOnO1gA9AJqF-JDQ6tP86rAjmonCxUX8MEOkYFZ5yi2IcUzQ/exec') {
          console.error("SCRIPT_URL is not set.");
          return { status: 'error', message: 'กรุณาใส่ Apps Script URL ในโค้ดก่อน' };
      }
      
      const url = `${SCRIPT_URL}?action=${action}`;
      try {
          const response = await fetch(url, {
              method: 'POST',
              mode: 'cors', 
              cache: 'no-cache',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload)
          });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          const dataText = await response.text();
          return JSON.parse(dataText);
      } catch (error) {
          console.error(`Error in postData for action ${action}:`, error);
          return { status: 'error', message: `การเชื่อมต่อล้มเหลว: ${error.message}` };
      }
    }

    // --------------------------------------------------------------------------------
    // ส่วนที่ 2: ตัวแปรและการกำหนดค่า (Variables and Configs)
    // --------------------------------------------------------------------------------
    const defaultConfig = {
      app_name: 'ระบบลงทะเบียนอุปกรณ์',
      primary_color: '#667eea',
      secondary_color: '#764ba2',
      departments: ['IT', 'บัญชี', 'บุคคล', 'การตลาด', 'อื่นๆ'],
      device_types: ['คอมพิวเตอร์', 'โน้ตบุ๊ก', 'เซิร์ฟเวอร์', 'แท็บเล็ต', 'เครื่องพิมพ์', 'อื่นๆ']
    };

    let currentConfig = defaultConfig;
    let allDevices = [];
    let currentImageData = null;
    let currentAssetImageData = null;
    let currentTab = 'register';

    // --------------------------------------------------------------------------------
    // ส่วนที่ 3: ฟังก์ชันการจัดการ UI และ Data
    // --------------------------------------------------------------------------------

    function switchTab(tabId) {
      currentTab = tabId;
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

      document.getElementById(`tab-${tabId}`).classList.add('active');
      document.getElementById(`tab-${tabId}-btn`).classList.add('active');
    }

    function handleDropdownChange(type) {
      const dropdown = document.getElementById(type);
      const customGroup = document.getElementById(`custom-${type}-group`);
      const customInput = document.getElementById(`custom_${type}`);

      if (dropdown.value === 'อื่นๆ') {
        customGroup.style.display = 'flex';
        customInput.required = true;
      } else {
        customGroup.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    }

    function clearImage() {
      currentImageData = null;
      const preview = document.getElementById('image_preview');
      const text = document.getElementById('upload-text');
      const clearBtn = document.getElementById('clear-image-btn');
      preview.src = '';
      preview.style.display = 'none';
      text.style.display = 'block';
      clearBtn.classList.remove('show');
    }

    function clearAssetImage() {
      currentAssetImageData = null;
      const preview = document.getElementById('asset_image_preview');
      const text = document.getElementById('asset-upload-text');
      const clearBtn = document.getElementById('clear-asset-image-btn');
      preview.src = '';
      preview.style.display = 'none';
      text.style.display = 'block';
      clearBtn.classList.remove('show');
    }

    function handleImageSelect(event) {
      handleImageSelection(event, 'image_preview', 'upload-text', 'clear-image-btn', (data) => currentImageData = data);
    }

    function handleAssetImageSelect(event) {
      handleImageSelection(event, 'asset_image_preview', 'asset-upload-text', 'clear-asset-image-btn', (data) => currentAssetImageData = data);
    }

    function handleImageSelection(event, previewId, textId, clearBtnId, setDataCallback) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        setDataCallback(dataUrl);

        const preview = document.getElementById(previewId);
        const text = document.getElementById(textId);
        const clearBtn = document.getElementById(clearBtnId);

        preview.src = dataUrl;
        preview.style.display = 'block';
        text.style.display = 'none';
        clearBtn.classList.add('show');
      };
      reader.readAsDataURL(file);
    }

    function renderDeviceList() {
      const container = document.getElementById('device-list-container');
      document.getElementById('device-count').textContent = allDevices.length;

      if (allDevices.length === 0) {
        container.innerHTML = '<div class="no-data">ไม่พบข้อมูลอุปกรณ์</div>';
        return;
      }

      container.innerHTML = allDevices.map(device => `
        <div class="device-card">
          <img class="device-card-image" src="${device.image_data || device.asset_image_data || 'placeholder.jpg'}" alt="${device.device_name || 'Device Image'}">
          <div class="device-card-content">
            <h3 style="color: ${currentConfig.primary_color || '#667eea'};">${device.device_name || 'ไม่มีชื่อ'}</h3>
            <p><strong>ID/Serial:</strong> ${device.device_id || 'ไม่ระบุ'}</p>
            <p><strong>ผู้ใช้งาน:</strong> ${device.user_name || 'ไม่ระบุ'}</p>
            <div class="badge-container">
              <span class="badge" style="background: ${currentConfig.secondary_color || '#764ba2'};">${device.device_type || 'ไม่ระบุ'}</span>
              <span class="badge" style="background: ${currentConfig.secondary_color || '#764ba2'};">${device.department}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function onConfigChange(config) {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      
      document.getElementById('app-name').textContent = config.app_name || defaultConfig.app_name;
      document.querySelectorAll('.tab-button.active').forEach(el => {
        el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
      });

      document.getElementById('register-form-title').style.color = primaryColor;
      document.getElementById('list-title').style.color = primaryColor;
      
      document.querySelectorAll('.device-card-content h3').forEach(el => {
        el.style.color = primaryColor;
      });

      document.querySelectorAll('.badge').forEach(el => {
        el.style.background = secondaryColor;
      });
      
      // Update dropdown options
      const departmentSelect = document.getElementById('department');
      const deviceTypeSelect = document.getElementById('device_type');
      
      const updateOptions = (selectElement, options) => {
          selectElement.innerHTML = '';
          options.forEach(option => {
              const opt = document.createElement('option');
              opt.value = option;
              opt.textContent = option;
              selectElement.appendChild(opt);
          });
      };

      updateOptions(departmentSelect, config.departments || defaultConfig.departments);
      updateOptions(deviceTypeSelect, config.device_types || defaultConfig.device_types);
    }

    function setupEventListeners() {
      // Setup listeners for custom inputs if needed (already handled by onchange)
    }


    // --- init() (ปรับปรุงใหม่) ---
    async function init() {
      // 1. โหลดข้อมูลการตั้งค่า (จำลองการตั้งค่าจาก Canva)
      const storedConfig = localStorage.getItem('app_config');
      if (storedConfig) {
        currentConfig = JSON.parse(storedConfig);
      }
      onConfigChange(currentConfig);

      // 2. ดึงข้อมูลอุปกรณ์ทั้งหมดจาก Google Sheets
      const result = await postData('read', {});
      
      if (result && result.status === 'success') {
        allDevices = result.data || [];
        renderDeviceList();
        showToast(`โหลดข้อมูลอุปกรณ์สำเร็จ: ${allDevices.length} รายการ`, 'success');
      } else {
        showToast(`ไม่สามารถโหลดข้อมูลอุปกรณ์ได้: ${result.message || 'กรุณาตรวจสอบ Apps Script'}`, 'error');
        renderDeviceList(); 
      }
      
      setupEventListeners();
    }

    // --- handleSubmit() (ปรับปรุงใหม่) ---
    async function handleSubmit() {
      if (!document.getElementById('device-form').checkValidity()) {
        showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
        return;
      }
      if (allDevices.length >= 999) {
        showToast('ถึงขีดจำกัดในการลงทะเบียน (999 รายการ)', 'error');
        return;
      }

      const submitBtn = document.getElementById('submit-btn');
      const btnText = document.getElementById('submit-btn-text');
      
      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="loading-spinner"></span>กำลังบันทึก...';

      const selectedDepartment = document.getElementById('department').value;
      const customDepartment = document.getElementById('custom_department').value;
      const finalDepartment = selectedDepartment === 'อื่นๆ' ? customDepartment : selectedDepartment;

      const selectedDeviceType = document.getElementById('device_type').value;
      const customDeviceType = document.getElementById('custom_device_type').value;
      const finalDeviceType = selectedDeviceType === 'อื่นๆ' ? customDeviceType : selectedDeviceType;

      const formData = {
        device_id: document.getElementById('device_id').value,
        device_name: document.getElementById('device_name').value,
        user_name: document.getElementById('user_name').value,
        department: finalDepartment,
        custom_department: selectedDepartment === 'อื่นๆ' ? customDepartment : '',
        device_type: finalDeviceType,
        custom_device_type: selectedDeviceType === 'อื่นๆ' ? customDeviceType : '',
        detail: document.getElementById('detail').value || '',
        // ส่ง Base64 ไปให้ Apps Script จัดการอัปโหลดไป Google Drive
        image_data: currentImageData || '', 
        asset_image_data: currentAssetImageData || '', 
        created_at: new Date().toISOString()
      };

      // การบันทึกข้อมูล: ใช้ Apps Script แทน Data SDK
      try {
        const result = await postData('create', formData);

        if (result && result.status === 'success') {
          showToast('บันทึกข้อมูลสำเร็จ', 'success');
          // ดึงข้อมูลใหม่เพื่ออัปเดตรายการ
          await init(); 
          
          // ล้างฟอร์ม
          document.getElementById('device-form').reset();
          clearImage();
          clearAssetImage();
          document.getElementById('custom-department-group').style.display = 'none';
          document.getElementById('custom-device-type-group').style.display = 'none';
          switchTab('list');
        } else {
          showToast(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${result.message || 'ไม่ทราบสาเหตุ'}`, 'error');
        }

      } catch (error) {
        console.error("Error submitting form via Apps Script:", error);
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์', 'error');
      }
      
      submitBtn.disabled = false;
      btnText.textContent = 'บันทึกข้อมูล';
    }

    init();
  </script>
 </body>
</html>